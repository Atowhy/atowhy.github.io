<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dofus Droprate Calculator</title>
    <link rel="stylesheet" href="style.css"> </head>
<body>
    <h1>Dofus Droprate Calculator</h1>

    <label for="itemSearchInput">Search Item:</label>
    <input type="text" id="itemSearchInput" value="Iron">
    <button id="searchButton">Search</button>

    <div id="itemInfo">
        <h2>Item Details:</h2>
        <p>Item Name: <span id="itemName">N/A</span></p>
        <p>Item ID: <span id="itemId">N/A</span></p>
        <h3>Monsters that drop this item:</h3>
        <ul id="monsterList">
            <li>No data yet.</li>
        </ul>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const itemSearchInput = document.getElementById('itemSearchInput');
            const searchButton = document.getElementById('searchButton');
            const itemNameSpan = document.getElementById('itemName');
            const itemIdSpan = document.getElementById('itemId');
            const monsterList = document.getElementById('monsterList');

            // DofusDB API base URL
            const dofusDBApiBase = 'https://api.dofusdb.fr';
            
            // The CORS proxy URL - STILL ESSENTIAL FOR GITHUB PAGES
            const corsProxy = 'https://corsproxy.io/'; 

            searchButton.addEventListener('click', fetchItemData);

            // Allow pressing Enter in the input field to trigger search
            itemSearchInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    fetchItemData();
                }
            });

            // Initial fetch on load for "Iron"
            fetchItemData();

            async function fetchItemData() {
                const searchTerm = itemSearchInput.value.trim();
                if (!searchTerm) {
                    alert('Please enter an item name to search.');
                    return;
                }

                itemNameSpan.textContent = 'Loading...';
                itemIdSpan.textContent = 'Loading...';
                monsterList.innerHTML = '<li>Loading...</li>';

                try {
                    // 1. Search for the item using the FeathersJS `name[$like]` query
                    const itemApiUrl = `${corsProxy}?${encodeURIComponent(`${dofusDBApiBase}/items?name[$like]=%${searchTerm}%`)}`;
                    console.log('Fetching item from:', itemApiUrl);

                    const itemResponse = await fetch(itemApiUrl);
                    if (!itemResponse.ok) {
                        throw new Error(`HTTP error! Status: ${itemResponse.status}`);
                    }
                    const itemData = await itemResponse.json();
                    console.log('Item API Response:', itemData);

                    let foundItem = null;
                    if (itemData && itemData.data && itemData.data.length > 0) {
                        // Assuming the first result is the most relevant, or you might need more logic
                        foundItem = itemData.data[0]; 
                        itemNameSpan.textContent = foundItem.name.en || foundItem.name; // Access English name if available, otherwise generic
                        itemIdSpan.textContent = foundItem._id;
                    } else {
                        itemNameSpan.textContent = 'Item not found.';
                        itemIdSpan.textContent = 'N/A';
                        monsterList.innerHTML = '<li>Item not found.</li>';
                        return; // Stop if item is not found
                    }

                    // 2. Now, to find drop rates, we need to search for monsters that drop this item.
                    // The DofusDB API doesn't seem to have a direct endpoint for "monsters that drop item X".
                    // This is a common challenge. We have two main approaches:
                    //    a) Fetch ALL monsters and filter client-side (bad for large datasets)
                    //    b) If the API allows, query monsters by a field that contains item drops (more efficient)

                    // Based on the provided endpoints, there's a `/monsters` endpoint.
                    // We need to see the structure of a monster object to know how to query for drops.
                    // Let's assume (for now) that a monster object *might* have a 'drops' array or similar field
                    // that references item IDs. If not, we'll have to iterate through all monsters.

                    // For demonstration, let's try to fetch all monsters and filter for our item's ID.
                    // This is NOT efficient for a full game, but helps us understand the data structure.
                    // We'll add a $limit to not fetch too many for now.

                    const monsterApiUrl = `${corsProxy}?${encodeURIComponent(`${dofusDBApiBase}/monsters?$limit=100`)}`; // Fetch first 100 monsters
                    console.log('Fetching monsters from:', monsterApiUrl);

                    const monsterResponse = await fetch(monsterApiUrl);
                    if (!monsterResponse.ok) {
                        throw new Error(`HTTP error! Status: ${monsterResponse.status}`);
                    }
                    const monsterData = await monsterResponse.json();
                    console.log('Monster API Response:', monsterData);

                    if (monsterData && monsterData.data && monsterData.data.length > 0) {
                        monsterList.innerHTML = ''; // Clear previous loading message
                        let foundDrops = false;
                        monsterData.data.forEach(monster => {
                            // This is a placeholder! We need to inspect actual monster data from the API
                            // to know the exact field where drops are listed and how they reference items.
                            // Assuming 'drops' is an array of objects, and each object has 'itemId' and 'rate'
                            if (monster.drops && Array.isArray(monster.drops)) {
                                monster.drops.forEach(drop => {
                                    if (drop.item && drop.item._id === foundItem._id) {
                                        const listItem = document.createElement('li');
                                        listItem.textContent = `${monster.name.en || monster.name} (Drop Rate: ${drop.rate || 'N/A'}%)`;
                                        monsterList.appendChild(listItem);
                                        foundDrops = true;
                                    }
                                });
                            }
                        });

                        if (!foundDrops) {
                            monsterList.innerHTML = '<li>No monsters found that directly drop this item (or API structure not yet understood).</li>';
                        }
                    } else {
                        monsterList.innerHTML = '<li>No monster data available.</li>';
                    }

                } catch (error) {
                    console.error('Fetch error:', error);
                    itemNameSpan.textContent = 'Error loading item.';
                    itemIdSpan.textContent = 'Error.';
                    monsterList.innerHTML = `<li>Error: ${error.message}</li>`;
                }
            }
        });
    </script>
</body>
</html>