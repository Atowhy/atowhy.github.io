<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur de Taux de Butin</title>
    <link rel="icon" type="image/png" href="images/tifoux.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        .main-container::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            /* Placeholder for background image. Replace with a valid URL if you have one, or remove if not needed. */
            background-image: url('https://placehold.co/1920x1080/111827/ffffff?text=Background');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.1;
            z-index: -1;
        }
        .card-bg {
            background-color: rgba(31, 41, 55, 0.85); /* bg-gray-800 with 85% opacity */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .placeholder-custom::placeholder {
            color: #9ca3af;
        }

        /* Styles pour les messages d'erreur/succès, adaptés au thème sombre */
        .message-box {
            padding: 1rem;
            margin-top: 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
        }
        .message-box.error {
            background-color: rgba(239, 68, 68, 0.1); /* Red-500 avec opacité */
            color: #ef4444; /* text-red-500 */
            border-left: 4px solid #ef4444; /* border-red-500 */
        }
        .message-box.success {
            background-color: rgba(20, 184, 166, 0.1); /* Teal-500 avec opacité */
            color: #14b8a6; /* text-teal-500 */
            border-left: 4px solid #14b8a6; /* border-teal-500 */
        }
        .message-box.info {
            background-color: rgba(59, 130, 246, 0.1); /* Blue-500 with opacity */
            color: #3b82f6; /* text-blue-500 */
            border-left: 4px solid #3b82f6; /* border-blue-500 */
        }

        /* Styles pour l'autocomplétion */
        .autocomplete-suggestions {
            position: absolute;
            background-color: rgba(31, 41, 55, 0.95); /* Slightly more opaque than card-bg */
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            width: calc(100% - 0.5rem); /* Adjust width to match input */
            left: 0.25rem; /* Align with input padding */
            top: 100%; /* Position below the input */
            margin-top: 0.25rem;
        }
        .autocomplete-suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: background-color 0.2s ease;
        }
        .autocomplete-suggestion-item:hover {
            background-color: rgba(20, 184, 166, 0.2); /* teal-500 with opacity */
        }
        .autocomplete-suggestion-item img {
            width: 32px;
            height: 32px;
            object-fit: contain;
            border-radius: 0.25rem;
            background-color: rgba(255, 255, 255, 0.05); /* subtle background for image */
        }

        /* Styles for monster drop suggestions */
        .monster-drop-suggestions {
            position: relative; /* Changed to relative to contain children */
            background-color: rgba(31, 41, 55, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.5rem;
            padding: 0.5rem;
            margin-top: 1rem;
        }
        .monster-drop-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease;
        }
        .monster-drop-item:hover {
            background-color: rgba(20, 184, 166, 0.2);
        }
        .monster-drop-item img {
            width: 28px;
            height: 28px;
            object-fit: contain;
            border-radius: 0.25rem;
        }
        .monster-drop-item span {
            flex-grow: 1;
            color: #e2e8f0; /* text-gray-200 */
        }
        .monster-drop-item .drop-rate {
            font-weight: 600;
            color: #4fd1c5; /* teal-300 */
        }
    </style>
</head>
<body class="text-white antialiased">

    <div class="main-container relative min-h-screen">
        <div class="relative z-10 container mx-auto p-4 md:p-8 max-w-md min-h-screen flex flex-col">
            
            <div class="flex justify-between items-center mb-4">
                <!-- Lien de retour à la page d'accueil du GitHub Pages -->
                <a href="https://atowhy.github.io/" class="text-teal-400 hover:text-teal-300" data-translate-key="btn_back_home">&larr; Retour à l'accueil</a>
                <select id="language-selector" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-1 text-white focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                    <option value="fr">🇫🇷 Français</option>
                    <option value="en">🇬🇧 English</option>
                    <option value="es">🇪🇸 Español</option>
                    <option value="pt-br">🇧🇷 Português (BR)</option>
                    <option value="it">🇮🇹 Italiano</option>
                </select>
            </div>

            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-teal-400" data-translate-key="drop_calculator_main_title">Calculateur de Taux de Butin</h1>
                <p class="text-gray-400 mt-2" data-translate-key="drop_calculator_subtitle">Estimez vos chances d'obtenir des objets !</p>
            </header>

            <!-- Contenu du Calculateur de Taux de Butin -->
            <div id="content-drop-calculator">
                <div class="card-bg p-6 rounded-2xl shadow-lg mb-8">
                    <h2 class="text-xl font-semibold mb-4 text-white" data-translate-key="drop_calculator_form_title">Calculer le Taux de Butin</h2>
                    
                    <div class="mb-4 relative">
                        <label for="dropItemName" class="block text-sm font-medium text-gray-300 mb-1" data-translate-key="label_item_name">Nom de l'objet (Ex: Casque Cassé du Chafer):</label>
                        <div class="flex items-center gap-2">
                            <img id="itemIcon" src="https://placehold.co/32x32/1f2937/9ca3af?text=?" alt="Icône de l'objet" class="h-8 w-8 rounded-md object-contain border border-gray-600">
                            <input type="text" id="dropItemName" value="Casque Cassé du Chafer" class="flex-grow bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition placeholder-custom">
                        </div>
                        <div id="autocompleteSuggestions" class="autocomplete-suggestions hidden"></div>
                    </div>

                    <!-- New section for monster drop suggestions -->
                    <div id="monsterDropSuggestions" class="monster-drop-suggestions hidden">
                        <p class="text-gray-400 text-sm mb-2" data-translate-key="label_select_monster_drop">Sélectionnez un monstre pour pré-remplir le taux de butin :</p>
                        <div id="monsterDropList" class="space-y-1">
                            <!-- Monster drop items will be inserted here -->
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="dropBaseDropRate" class="block text-sm font-medium text-gray-300 mb-1" data-translate-key="label_base_drop_rate">Taux de butin de base (%) (Ex: 8.4 pour Casque Cassé du Chafer):</label>
                        <input type="number" id="dropBaseDropRate" value="8.4" min="0.1" step="0.1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition placeholder-custom">
                    </div>

                    <div class="mb-4">
                        <label for="dropPlayerPP" class="block text-sm font-medium text-gray-300 mb-1" data-translate-key="label_player_pp">Votre Prospection (PP):</label>
                        <input type="number" id="dropPlayerPP" value="100" min="100" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition placeholder-custom">
                    </div>

                    <div class="mb-4">
                        <label for="dropChallengeBonus" class="block text-sm font-medium text-gray-300 mb-1" data-translate-key="label_challenge_bonus">Bonus de défi (%) (Ex: 50 pour un défi réussi):</label>
                        <input type="number" id="dropChallengeBonus" value="50" min="0" step="1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition placeholder-custom">
                    </div>

                    <!-- Champ pour le % Anomalie -->
                    <div class="mb-4">
                        <label for="dropAnomalyBonus" class="block text-sm font-medium text-gray-300 mb-1" data-translate-key="label_anomaly_bonus">% Anomalie (0-120%):</label>
                        <input type="number" id="dropAnomalyBonus" value="0" min="0" max="120" step="1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition placeholder-custom">
                    </div>

                    <!-- Toggle pour Ankama Shield -->
                    <div class="mb-6 flex items-center">
                        <input type="checkbox" id="ankamaShieldToggle" checked class="h-4 w-4 text-teal-600 bg-gray-700 border-gray-600 rounded focus:ring-teal-500">
                        <label for="ankamaShieldToggle" class="ml-2 block text-sm font-medium text-gray-300" data-translate-key="label_ankama_shield">Activer Ankama Shield (+5% bonus)</label>
                    </div>

                    <button onclick="calculateDropRate()" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-md" data-translate-key="btn_calculate_drop_rate">
                        Calculer le Taux de Butin
                    </button>

                    <div id="drop-result" class="message-box success hidden">
                        <!-- Le résultat sera affiché ici -->
                    </div>
                    <div id="drop-error-message" class="message-box error hidden">
                        <!-- Les messages d'erreur seront affichés ici -->
                    </div>
                    <div id="drop-info-message" class="message-box info hidden">
                        <!-- Information messages (e.g., loading) will be displayed here -->
                    </div>
                </div>
            </div>
            
            <footer class="text-center text-gray-500 text-sm mt-auto pt-12 pb-4">
                <!-- Placeholder for Dofus Logo. Replace with a valid URL if you have one, or remove if not needed. -->
                <img src="https://placehold.co/48x48/111827/9ca3af?text=Dofus" alt="Logo Dofus" class="h-12 mx-auto mb-2 opacity-50">
                <p data-translate-key="signature">Apps by Ato</p>
                <p class="text-xs text-gray-600 mt-4" data-translate-key="disclaimer">Dofus and any related images used on this website are the properties of Ankama</p>
                <p class="text-xs text-gray-600 mt-2" data-translate-key="version_info"></p>
            </footer>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const translations = {
                fr: {
                    btn_back_home: "← Retour à l'accueil",
                    signature: "Apps by Ato",
                    disclaimer: "Dofus et toutes les images associées utilisées sur ce site sont la propriété d'Ankama",
                    version_info: "Version 1.0.2 - Juillet 2025", // Updated version
                    drop_calculator_main_title: "Calculateur de Taux de Butin",
                    drop_calculator_subtitle: "Estimez vos chances d'obtenir des objets !",
                    drop_calculator_form_title: "Calculer le Taux de Butin",
                    label_item_name: "Nom de l'objet (Ex: Casque Cassé du Chafer):",
                    label_base_drop_rate: "Taux de butin de base (%) (Ex: 8.4 pour Casque Cassé du Chafer):",
                    label_player_pp: "Votre Prospection (PP):",
                    label_challenge_bonus: "Bonus de défi (%) (Ex: 50 pour un défi réussi):",
                    label_anomaly_bonus: "% Anomalie (0-120%):",
                    label_ankama_shield: "Activer Ankama Shield (+5% bonus)",
                    btn_calculate_drop_rate: "Calculer le Taux de Butin",
                    drop_result_prefix: "Pour l'objet",
                    drop_estimated_rate: "Taux de butin estimé",
                    drop_average_combats: "Vous avez 1 chance sur",
                    drop_error_message: "Veuillez entrer des valeurs numériques valides pour le taux de base, la prospection (min 100), le bonus de défi (min 0) et le bonus d'anomalie (entre 0 et 120).",
                    drop_error_item_name: "Veuillez entrer un nom pour l'objet.",
                    item_not_found: "Objet non trouvé.",
                    fetching_data: "Recherche en cours...",
                    no_base_drop_rate: "Aucun taux de butin de base trouvé pour cet objet via les monstres. Veuillez l'entrer manuellement.",
                    label_select_monster_drop: "Sélectionnez un monstre pour pré-remplir le taux de butin :",
                    no_monster_drops: "Aucun monstre ne semble laisser tomber cet objet, ou les données ne sont pas disponibles."
                },
                en: {
                    btn_back_home: "← Back to Home",
                    signature: "Apps by Ato",
                    disclaimer: "Dofus and any related images used on this website are the properties of Ankama",
                    version_info: "Version 1.0.2 - July 2025", // Updated version
                    drop_calculator_main_title: "Drop Rate Calculator",
                    drop_calculator_subtitle: "Estimate your chances of obtaining items!",
                    drop_calculator_form_title: "Calculate Drop Rate",
                    label_item_name: "Item Name (Ex: Broken Chafer Helmet):",
                    label_base_drop_rate: "Base Drop Rate (%) (Ex: 8.4 for Broken Chafer Helmet):",
                    label_player_pp: "Your Prospecting (PP):",
                    label_challenge_bonus: "Challenge Bonus (%) (Ex: 50 for a successful challenge):",
                    label_anomaly_bonus: "Anomaly % (0-120%):",
                    label_ankama_shield: "Activate Ankama Shield (+5% bonus)",
                    btn_calculate_drop_rate: "Calculate Drop Rate",
                    drop_result_prefix: "For the item",
                    drop_estimated_rate: "Estimated drop rate",
                    drop_average_combats: "You have 1 chance in",
                    drop_error_message: "Please enter valid numeric values for base rate, prospecting (min 100), challenge bonus (min 0), and anomaly bonus (between 0 and 120).",
                    drop_error_item_name: "Please enter an item name.",
                    item_not_found: "Item not found.",
                    fetching_data: "Searching...",
                    no_base_drop_rate: "No base drop rate found for this item via monsters. Please enter it manually.",
                    label_select_monster_drop: "Select a monster to pre-fill the drop rate:",
                    no_monster_drops: "No monsters seem to drop this item, or data is unavailable."
                },
                es: {
                    btn_back_home: "← Volver al Inicio",
                    signature: "Apps by Ato",
                    disclaimer: "Dofus y cualquier imagen relacionada utilizada en este sitio web son propiedad de Ankama",
                    version_info: "Versión 1.0.2 - Julio 2025", // Updated version
                    drop_calculator_main_title: "Calculadora de Tasa de Drop",
                    drop_calculator_subtitle: "¡Estima tus posibilidades de conseguir objetos!",
                    drop_calculator_form_title: "Calcular Tasa de Drop",
                    label_item_name: "Nombre del objeto (Ej: Casco Roto de Chafer):",
                    label_base_drop_rate: "Tasa de drop base (%) (Ej: 8.4 para Casco Roto de Chafer):",
                    label_player_pp: "Tu Prospección (PP):",
                    label_challenge_bonus: "Bono de desafío (%) (Ej: 50 para un desafío exitoso):",
                    label_anomaly_bonus: "% Anomalía (0-120%):",
                    label_ankama_shield: "Activar Ankama Shield (+5% bonus)",
                    btn_calculate_drop_rate: "Calcular Tasa de Drop",
                    drop_result_prefix: "Para el objeto",
                    drop_estimated_rate: "Tasa de drop estimada",
                    drop_average_combats: "Tienes 1 oportunidad entre",
                    drop_error_message: "Por favor, introduce valores numéricos válidos para la tasa base, la prospección (mín. 100), el bono de desafío (mín. 0) y el bono de anomalía (entre 0 y 120).",
                    drop_error_item_name: "Por favor, introduce un nombre para el objeto.",
                    item_not_found: "Objeto no encontrado.",
                    fetching_data: "Buscando...",
                    no_base_drop_rate: "No se encontró una tasa de drop base para este objeto a través de monstruos. Por favor, introdúcela manualmente.",
                    label_select_monster_drop: "Selecciona un monstruo para rellenar la tasa de drop:",
                    no_monster_drops: "Ningún monstro parece soltar este objeto, o los datos no están disponibles."
                },
                'pt-br': {
                    btn_back_home: "← Voltar ao Início",
                    signature: "Apps by Ato",
                    disclaimer: "Dofus e quaisquer imagens relacionadas usadas neste site são propriedade da Ankama",
                    version_info: "Versão 1.0.2 - Julho 2025", // Updated version
                    drop_calculator_main_title: "Calculadora Taxa de Drop",
                    drop_calculator_subtitle: "Estime suas chances de obter itens!",
                    drop_calculator_form_title: "Calcular Taxa de Drop",
                    label_item_name: "Nome do Item (Ex: Capacete Quebrado de Chafer):",
                    label_base_drop_rate: "Taxa de Drop Base (%) (Ex: 8.4 para Capacete Quebrado de Chafer):",
                    label_player_pp: "Sua Prospecção (PP):",
                    label_challenge_bonus: "Bônus de Desafio (%) (Ex: 50 para um desafio bem-sucedido):",
                    label_anomaly_bonus: "% Anomalia (0-120%):",
                    label_ankama_shield: "Ativar Ankama Shield (+5% bônus)",
                    btn_calculate_drop_rate: "Calcular Taxa de Drop",
                    drop_result_prefix: "Para o item",
                    drop_estimated_rate: "Taxa de drop estimada",
                    drop_average_combats: "Você tem 1 chance em",
                    drop_error_message: "Por favor, insira valores numéricos válidos para a taxa base, prospecção (mín. 100), bônus de desafio (mín. 0) e bônus de anomalia (entre 0 e 120).",
                    drop_error_item_name: "Por favor, insira um nome para o item.",
                    item_not_found: "Item não encontrado.",
                    fetching_data: "Pesquisando...",
                    no_base_drop_rate: "Nenhuma taxa de drop base encontrada para este item via monstros. Por favor, insira-a manualmente.",
                    label_select_monster_drop: "Selecione um monstro para preencher a taxa de drop:",
                    no_monster_drops: "Nenhum monstro parece dropar este item, ou os dados não estão disponíveis."
                },
                it: {
                    btn_back_home: "← Torna alla Home",
                    signature: "Apps by Ato",
                    disclaimer: "Dofus e qualsiasi immagine correlata utilizzata su questo sito Web è di proprietà di Ankama",
                    version_info: "Versione 1.0.2 - Luglio 2025", // Updated version
                    drop_calculator_main_title: "Calcolatore Tasso di Drop",
                    drop_calculator_subtitle: "Stima le tue possibilità di ottenere oggetti!",
                    drop_calculator_form_title: "Calcola Tasso di Drop",
                    label_item_name: "Nome dell'oggetto (Es: Elmo Rotto di Chafer):",
                    label_base_drop_rate: "Tasso di drop base (%) (Es: 8.4 per Elmo Rotto di Chafer):",
                    label_player_pp: "La tua Prospezione (PP):",
                    label_challenge_bonus: "Bonus di sfida (%) (Es: 50 per una sfida riuscita):",
                    label_anomaly_bonus: "% Anomalia (0-120%):",
                    label_ankama_shield: "Attiva Ankama Shield (+5% bonus)",
                    btn_calculate_drop_rate: "Calcola Tasso di Drop",
                    drop_result_prefix: "Per l'oggetto",
                    drop_estimated_rate: "Tasso di drop stimato",
                    drop_average_combats: "Hai 1 possibilità su",
                    drop_error_message: "Inserisci valori numerici validi per il tasso base, la prospezione (min 100), il bonus di sfida (min 0) e il bonus di anomalia (tra 0 e 120).",
                    drop_error_item_name: "Inserisci un nome per l'oggetto.",
                    item_not_found: "Oggetto non trovato.",
                    fetching_data: "Ricerca in corso...",
                    no_base_drop_rate: "Nessun tasso di drop base trovato per questo oggetto tramite i mostri. Inseriscilo manualmente.",
                    label_select_monster_drop: "Seleziona un mostro per precompilare il tasso di drop:",
                    no_monster_drops: "Nessun mostro sembra rilasciare questo oggetto, o i dati non sono disponibili."
                }
            };

            // Elements for Drop Calculator
            const dropItemNameInput = document.getElementById('dropItemName');
            const dropBaseDropRateInput = document.getElementById('dropBaseDropRate');
            const dropPlayerPPInput = document.getElementById('dropPlayerPP');
            const dropChallengeBonusInput = document.getElementById('dropChallengeBonus');
            const dropAnomalyBonusInput = document.getElementById('dropAnomalyBonus');
            const ankamaShieldToggle = document.getElementById('ankamaShieldToggle');
            const dropResultDiv = document.getElementById('drop-result');
            const dropErrorDiv = document.getElementById('drop-error-message');
            const dropInfoDiv = document.getElementById('drop-info-message'); // New info message div
            const languageSelector = document.getElementById('language-selector');
            const itemIcon = document.getElementById('itemIcon');
            const autocompleteSuggestions = document.getElementById('autocompleteSuggestions');
            const monsterDropSuggestions = document.getElementById('monsterDropSuggestions'); // New monster drop section
            const monsterDropList = document.getElementById('monsterDropList'); // List within monster drop section
            const versionInfoElement = document.querySelector('[data-translate-key="version_info"]'); // Get the version info element

            let currentLanguage = 'fr';
            let selectedItem = null; // To store the currently selected item object from API

            const DOFUSDB_API_BASE_URL = 'https://api.dofusdb.fr';

            // Utility function to display messages
            function showMessage(element, message, type) {
                element.innerHTML = `<p>${message}</p>`;
                element.className = `message-box ${type}`;
                element.classList.remove('hidden');
            }

            function hideMessage(element) {
                element.classList.add('hidden');
                element.innerHTML = '';
            }

            // Function to fetch Dofus items from API for autocomplete
            async function fetchItemsForAutocomplete(searchTerm) {
                hideMessage(dropErrorDiv);
                hideMessage(dropResultDiv);
                hideMessage(monsterDropSuggestions); // Hide monster suggestions when typing
                dropBaseDropRateInput.removeAttribute('disabled'); // Enable manual input

                if (searchTerm.length < 3) {
                    autocompleteSuggestions.classList.add('hidden');
                    autocompleteSuggestions.innerHTML = '';
                    return;
                }

                showMessage(dropInfoDiv, translations[currentLanguage].fetching_data, 'info');
                autocompleteSuggestions.innerHTML = ''; // Clear previous suggestions
                autocompleteSuggestions.classList.remove('hidden');

                try {
                    const params = new URLSearchParams();
                    // The DofusDB API (FeathersJS) uses a specific syntax for $like.
                    // Special characters in the search term itself (like 'é', 'à', etc.) need to be handled by URLSearchParams.
                    // The '$like' operator itself should be part of the parameter name.
                    params.append('nom[$like]', `%${searchTerm}%`);
                    params.append('_limit', '10');

                    const response = await fetch(`${DOFUSDB_API_BASE_URL}/items?${params.toString()}`);
                    if (!response.ok) {
                        // Log the full URL for debugging purposes
                        console.error(`API request failed with status ${response.status}. URL: ${response.url}`);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const items = await response.json();
                    hideMessage(dropInfoDiv);

                    if (items.length > 0) {
                        items.forEach(item => {
                            const suggestionDiv = document.createElement('div');
                            suggestionDiv.classList.add('autocomplete-suggestion-item');
                            suggestionDiv.innerHTML = `
                                <img src="${item.illustration_url || 'https://placehold.co/32x32/1f2937/9ca3af?text=?'}" alt="Icône de ${item.nom}">
                                <span>${item.nom}</span>
                            `;
                            suggestionDiv.addEventListener('click', () => {
                                selectItem(item);
                                autocompleteSuggestions.classList.add('hidden');
                            });
                            autocompleteSuggestions.appendChild(suggestionDiv);
                        });
                    } else {
                        autocompleteSuggestions.classList.add('hidden');
                        showMessage(dropErrorDiv, translations[currentLanguage].item_not_found, 'error');
                    }
                } catch (error) {
                    console.error("Error fetching items:", error);
                    hideMessage(dropInfoDiv);
                    // Provide a more user-friendly error message if the API call truly failed
                    showMessage(dropErrorDiv, translations[currentLanguage].item_not_found + " " + (error.message || ""), 'error');
                    autocompleteSuggestions.classList.add('hidden');
                }
            }

            // Function to handle item selection from autocomplete
            async function selectItem(item) {
                selectedItem = item;
                dropItemNameInput.value = item.nom;
                itemIcon.src = item.illustration_url || "https://placehold.co/32x32/1f2937/9ca3af?text=?";
                hideMessage(dropErrorDiv);
                hideMessage(dropResultDiv);
                dropBaseDropRateInput.value = ''; // Clear base drop rate
                dropBaseDropRateInput.removeAttribute('disabled'); // Ensure it's enabled for manual input initially

                // Display monster drop options if available
                if (selectedItem.dropGroups && selectedItem.dropGroups.length > 0) {
                    await displayMonsterDropOptions(selectedItem.dropGroups);
                } else {
                    hideMessage(monsterDropSuggestions);
                    monsterDropList.innerHTML = '';
                    showMessage(dropInfoDiv, translations[currentLanguage].no_monster_drops, 'info');
                }
            }

            // Function to display monster drop options
            async function displayMonsterDropOptions(dropGroups) {
                monsterDropList.innerHTML = '';
                hideMessage(dropInfoDiv); // Hide any previous info messages
                monsterDropSuggestions.classList.remove('hidden');

                const monsterPromises = dropGroups.map(async (group) => {
                    if (group.monsterId) {
                        try {
                            const response = await fetch(`${DOFUSDB_API_BASE_URL}/monsters/${group.monsterId}`);
                            if (!response.ok) {
                                console.error(`API request for monster ${group.monsterId} failed with status ${response.status}. URL: ${response.url}`);
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            const monster = await response.json();
                            return { monster, rate: group.rate };
                        } catch (error) {
                            console.error(`Error fetching monster ${group.monsterId}:`, error);
                            return null; // Return null for failed fetches
                        }
                    }
                    return null;
                });

                const monsterDrops = (await Promise.all(monsterPromises)).filter(Boolean); // Filter out nulls

                if (monsterDrops.length > 0) {
                    monsterDrops.forEach(({ monster, rate }) => {
                        const monsterDropDiv = document.createElement('div');
                        monsterDropDiv.classList.add('monster-drop-item');
                        monsterDropDiv.innerHTML = `
                            <img src="${monster.illustration_url || 'https://placehold.co/28x28/1f2937/9ca3af?text=?'}" alt="Icône de ${monster.nom}">
                            <span>${monster.nom}</span>
                            <span class="drop-rate">${rate}%</span>
                        `;
                        monsterDropDiv.addEventListener('click', () => {
                            dropBaseDropRateInput.value = rate;
                            dropBaseDropRateInput.setAttribute('disabled', 'true'); // Disable input after selection
                            hideMessage(monsterDropSuggestions); // Hide monster suggestions after selection
                        });
                        monsterDropList.appendChild(monsterDropDiv);
                    });
                } else {
                    showMessage(dropInfoDiv, translations[currentLanguage].no_monster_drops, 'info');
                    hideMessage(monsterDropSuggestions);
                }
            }
            
            // Translation Function
            function setLanguage(lang) {
                currentLanguage = lang;
                localStorage.setItem('dofusDropLang', lang);
                document.documentElement.lang = lang;
                languageSelector.value = lang;

                document.querySelectorAll('[data-translate-key]').forEach(element => {
                    const key = element.getAttribute('data-translate-key');
                    if (translations[lang] && translations[lang][key]) {
                        element.textContent = translations[lang][key];
                    }
                });

                // For placeholders, use data-translate-key-placeholder
                document.querySelectorAll('[data-translate-key-placeholder]').forEach(element => {
                    const key = element.getAttribute('data-translate-key-placeholder');
                    if (translations[lang] && translations[lang][key]) {
                        element.placeholder = translations[lang][key];
                    }
                });
                hideMessage(dropResultDiv);
                hideMessage(dropErrorDiv);
                hideMessage(dropInfoDiv);
            }

            // Drop Rate Calculator Logic
            window.calculateDropRate = function() {
                hideMessage(dropResultDiv);
                hideMessage(dropErrorDiv);
                hideMessage(dropInfoDiv);

                const itemName = dropItemNameInput.value.trim();
                const baseDropRate = parseFloat(dropBaseDropRateInput.value);
                let playerPP = parseFloat(dropPlayerPPInput.value);
                const challengeBonus = parseFloat(dropChallengeBonusInput.value);
                let anomalyBonus = parseFloat(dropAnomalyBonusInput.value);
                const isAnkamaShieldActive = ankamaShieldToggle.checked;

                if (isNaN(baseDropRate) || isNaN(playerPP) || isNaN(challengeBonus) || isNaN(anomalyBonus) || baseDropRate <= 0 || playerPP < 100 || anomalyBonus < 0 || anomalyBonus > 120) {
                    showMessage(dropErrorDiv, translations[currentLanguage].drop_error_message, 'error');
                    return;
                }

                if (itemName === "") {
                    showMessage(dropErrorDiv, translations[currentLanguage].drop_error_item_name, 'error');
                    return;
                }

                // PP Multiplier formula based on Dofus mechanics (simplified)
                let ppMultiplier;
                if (playerPP < 0) { // Should not happen with min="100" but as a safeguard
                    ppMultiplier = 1;
                } else {
                    const exponent = (250 - playerPP) / 85;
                    ppMultiplier = 0.74 + (1.755 / (1 + Math.exp(exponent)));
                    ppMultiplier = Math.min(ppMultiplier, 2.5); // Cap at 2.5 (250% of base)
                }

                let effectiveDropRate = baseDropRate * ppMultiplier * (1 + challengeBonus / 100);

                if (anomalyBonus > 0) {
                    effectiveDropRate *= (1 + anomalyBonus / 100);
                }

                if (isAnkamaShieldActive) {
                    effectiveDropRate *= (1 + 5 / 100); // +5% bonus from Ankama Shield
                }

                let chanceDenominator = 0;
                if (effectiveDropRate > 0) {
                    chanceDenominator = 100 / effectiveDropRate;
                } else {
                    chanceDenominator = Infinity; // Avoid division by zero
                }

                dropResultDiv.innerHTML = `
                    <p class="font-bold">${translations[currentLanguage].drop_result_prefix} "<strong>${itemName}</strong>" :</p>
                    <ul class="list-none mt-2">
                        <li class="text-lg mt-2"><strong>${translations[currentLanguage].drop_estimated_rate} : <span class="text-teal-300">${effectiveDropRate.toFixed(2)}%</span></strong></li>
                        <li class="text-gray-400 italic mt-4"><em>${translations[currentLanguage].drop_average_combats} <span class="font-semibold">${chanceDenominator.toFixed(0)}</span> !</em></li>
                    </ul>
                `;
                dropResultDiv.classList.remove('hidden');
            };

            // Event Listeners
            languageSelector.addEventListener('change', (e) => setLanguage(e.target.value));
            
            // Debounce function for autocomplete to limit API calls
            let debounceTimer;
            dropItemNameInput.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    fetchItemsForAutocomplete(dropItemNameInput.value);
                }, 300); // 300ms delay
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!dropItemNameInput.contains(e.target) && !autocompleteSuggestions.contains(e.target)) {
                    autocompleteSuggestions.classList.add('hidden');
                }
                // Keep monster suggestions visible until an option is chosen or item name is cleared
            });

            // Initial Load
            const savedLang = localStorage.getItem('dofusDropLang') || 'fr';
            setLanguage(savedLang);

            // Set the version information in the footer
            if (versionInfoElement) {
                versionInfoElement.textContent = translations[currentLanguage].version_info;
            }

            // Perform initial search for the default item on page load
            if (dropItemNameInput.value) {
                fetchItemsForAutocomplete(dropItemNameInput.value);
            }
        });
    </script>

</body>
</html>
