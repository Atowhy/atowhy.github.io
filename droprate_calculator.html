<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur de Taux de Butin</title>
    <link rel="icon" type="image/png" href="images/tifoux.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        .main-container::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            /* Placeholder for background image. Replace with a valid URL if you have one, or remove if not needed. */
            background-image: url('https://placehold.co/1920x1080/111827/ffffff?text=Background');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.1;
            z-index: -1;
        }
        .card-bg {
            background-color: rgba(31, 41, 55, 0.85); /* bg-gray-800 with 85% opacity */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .placeholder-custom::placeholder {
            color: #9ca3af;
        }

        /* Styles pour les messages d'erreur/succÃ¨s, adaptÃ©s au thÃ¨me sombre */
        .message-box {
            padding: 1rem;
            margin-top: 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
        }
        .message-box.error {
            background-color: rgba(239, 68, 68, 0.1); /* Red-500 avec opacitÃ© */
            color: #ef4444; /* text-red-500 */
            border-left: 4px solid #ef4444; /* border-red-500 */
        }
        .message-box.success {
            background-color: rgba(20, 184, 166, 0.1); /* Teal-500 avec opacitÃ© */
            color: #14b8a6; /* text-teal-500 */
            border-left: 4px solid #14b8a6; /* border-teal-500 */
        }
        .message-box.info {
            background-color: rgba(59, 130, 246, 0.1); /* Blue-500 with opacity */
            color: #3b82f6; /* text-blue-500 */
            border-left: 4px solid #3b82f6; /* border-blue-500 */
        }

        /* Styles pour l'autocomplÃ©tion */
        .autocomplete-suggestions {
            position: absolute;
            background-color: rgba(31, 41, 55, 0.95); /* Slightly more opaque than card-bg */
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            width: calc(100% - 0.5rem); /* Adjust width to match input */
            left: 0.25rem; /* Align with input padding */
            top: 100%; /* Position below the input */
            margin-top: 0.25rem;
        }
        .autocomplete-suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: background-color 0.2s ease;
        }
        .autocomplete-suggestion-item:hover {
            background-color: rgba(20, 184, 166, 0.2); /* teal-500 with opacity */
        }
        .autocomplete-suggestion-item img {
            width: 32px;
            height: 32px;
            object-fit: contain;
            border-radius: 0.25rem;
            background-color: rgba(255, 255, 255, 0.05); /* subtle background for image */
        }

        /* Styles for monster drop suggestions */
        .monster-drop-suggestions {
            position: relative;
            background-color: rgba(31, 41, 55, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.5rem;
            padding: 0.5rem;
            margin-top: 1rem; /* Consistent spacing */
            margin-bottom: 1rem; /* Consistent spacing */
            transition: all 0.3s ease-in-out;
            
            /* Initial state: hidden */
            display: none; 
            opacity: 0;
            height: 0; /* Start with 0 height for transition */

            max-height: 280px; /* Increased to ensure more lines are visible */
            overflow-y: auto; /* Apply scrollbar when content exceeds max-height */
        }
        .monster-drop-suggestions.is-visible {
            display: block;
            opacity: 1;
            height: auto; /* Allow height to adjust to content up to max-height */
            /* No explicit overflow here, let the base class handle it */
        }

        /* Custom scrollbar styles for Webkit browsers */
        .monster-drop-suggestions::-webkit-scrollbar {
            width: 8px; /* Width of the scrollbar */
        }

        .monster-drop-suggestions::-webkit-scrollbar-track {
            background: #374151; /* Color of the track */
            border-radius: 10px;
        }

        .monster-drop-suggestions::-webkit-scrollbar-thumb {
            background: #0d9488; /* Color of the scroll thumb */
            border-radius: 10px;
        }

        .monster-drop-suggestions::-webkit-scrollbar-thumb:hover {
            background: #0f766e; /* Color of the scroll thumb on hover */
        }


        .monster-drop-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem; /* Increased padding for more vertical space */
            cursor: pointer;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease;
        }
        .monster-drop-item:hover {
            background-color: rgba(20, 184, 166, 0.2);
        }
        .monster-drop-item img {
            width: 28px;
            height: 28px;
            object-fit: contain;
            border-radius: 0.25rem;
        }
        .monster-drop-item span {
            flex-grow: 1;
            color: #e2e8f0; /* text-gray-200 */
        }
        .monster-drop-item .drop-rate {
            font-weight: 600;
            color: #4fd1c5; /* teal-300 */
            min-width: 70px; /* Give it a fixed minimum width */
            text-align: right; /* Align text to the right within its own span */
        }

        /* Style for selected monster item */
        .monster-drop-item.is-selected {
            background-color: rgba(32, 178, 170, 0.4); /* A more prominent teal */
            border: 1px solid #4fd1c5; /* A subtle border */
        }
    </style>
</head>
<body class="text-white antialiased">

    <div class="main-container relative min-h-screen">
        <div class="relative z-10 container mx-auto p-4 md:p-8 max-w-md min-h-screen flex flex-col">
            
            <div class="flex justify-between items-center mb-4">
                <!-- Lien de retour Ã  la page d'accueil du GitHub Pages -->
                <a href="https://atowhy.github.io/" class="text-teal-400 hover:text-teal-300" data-translate-key="btn_back_home">&larr; Retour Ã  l'accueil</a>
                <select id="language-selector" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-1 text-white focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                    <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
                    <option value="en">ðŸ‡¬ðŸ‡§ English</option>
                    <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
                    <option value="pt-br">ðŸ‡§ðŸ‡· PortuguÃªs (BR)</option>
                    <option value="it">ðŸ‡®ðŸ‡¹ Italiano</option>
                </select>
            </div>

            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-teal-400" data-translate-key="drop_calculator_main_title">Calculateur de Taux de Butin</h1>
                <p class="text-gray-400 mt-2" data-translate-key="drop_calculator_subtitle">Estimez vos chances d'obtenir des objets !</p>
            </header>

            <!-- Contenu du Calculateur de Taux de Butin -->
            <div id="content-drop-calculator">
                <div class="card-bg p-6 rounded-2xl shadow-lg mb-8">
                    <h2 class="text-xl font-semibold mb-4 text-white" data-translate-key="drop_calculator_form_title">Calculer le Taux de Butin</h2>
                    
                    <div class="mb-4 relative">
                        <label for="dropItemName" class="block text-sm font-medium text-gray-300 mb-1" data-translate-key="label_item_name">Nom de l'objet (Ex: Casque CassÃ© du Chafer):</label>
                        <div class="flex items-center gap-2">
                            <img id="itemIcon" src="https://placehold.co/32x32/1f2937/9ca3af?text=?" alt="IcÃ´ne de l'objet" class="h-8 w-8 rounded-md object-contain border border-gray-600">
                            <input type="text" id="dropItemName" value="" placeholder="Casque CassÃ© du Chafer" class="flex-grow bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition placeholder-custom">
                        </div>
                        <div id="autocompleteSuggestions" class="autocomplete-suggestions hidden"></div>
                    </div>

                    <!-- New section for monster drop suggestions -->
                    <div id="monsterDropSuggestions" class="monster-drop-suggestions">
                        <p class="text-gray-400 text-sm mb-2" data-translate-key="label_select_monster_drop">SÃ©lectionnez un monstre pour prÃ©-remplir le taux de butin :</p>
                        <div id="monsterDropList" class="space-y-1">
                            <!-- Monster drop items will be inserted here -->
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="dropBaseDropRate" class="block text-sm font-medium text-gray-300 mb-1" data-translate-key="label_base_drop_rate">Taux de butin de base (%) (Ex: 8.4 pour Casque CassÃ© du Chafer):</label>
                        <input type="number" id="dropBaseDropRate" value="8.4" min="0.1" step="0.1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition placeholder-custom">
                    </div>

                    <div class="mb-4">
                        <label for="dropPlayerPP" class="block text-sm font-medium text-gray-300 mb-1" data-translate-key="label_player_pp">Votre Prospection (PP):</label>
                        <input type="number" id="dropPlayerPP" value="100" min="100" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition placeholder-custom">
                    </div>

                    <div class="mb-4">
                        <label for="dropChallengeBonus" class="block text-sm font-medium text-gray-300 mb-1" data-translate-key="label_challenge_bonus">Bonus de dÃ©fi (%) (Ex: 50 pour un dÃ©fi rÃ©ussi):</label>
                        <input type="number" id="dropChallengeBonus" value="50" min="0" step="1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition placeholder-custom">
                    </div>

                    <!-- Champ pour le % Anomalie -->
                    <div class="mb-4">
                        <label for="dropAnomalyBonus" class="block text-sm font-medium text-gray-300 mb-1" data-translate-key="label_anomaly_bonus">% Anomalie (0-120%):</label>
                        <input type="number" id="dropAnomalyBonus" value="0" min="0" max="120" step="1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition placeholder-custom">
                    </div>

                    <!-- Toggle pour Ankama Shield -->
                    <div class="mb-6 flex items-center">
                        <input type="checkbox" id="ankamaShieldToggle" checked class="h-4 w-4 text-teal-600 bg-gray-700 border-gray-600 rounded focus:ring-teal-500">
                        <label for="ankamaShieldToggle" class="ml-2 block text-sm font-medium text-gray-300" data-translate-key="label_ankama_shield">Activer Ankama Shield (+5% bonus)</label>
                    </div>

                    <button onclick="calculateDropRate()" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-md" data-translate-key="btn_calculate_drop_rate">
                        Calculer le Taux de Butin
                    </button>

                    <div id="drop-result" class="message-box success hidden">
                        <!-- Le rÃ©sultat sera affichÃ© ici -->
                    </div>
                    <div id="drop-error-message" class="message-box error hidden">
                        <!-- Les messages d'erreur seront affichÃ©s ici -->
                    </div>
                    <div id="drop-info-message" class="message-box info hidden">
                        <!-- Information messages (e.g., loading) will be displayed here -->
                    </div>
                </div>
            </div>
            
            <footer class="text-center text-gray-500 text-sm mt-auto pt-12 pb-4">
                <!-- Image of Dofus Logo -->
                <img src="https://placehold.co/48x48/111827/9ca3af?text=Dofus" alt="Logo Dofus" class="h-12 mx-auto mb-2 opacity-50">
                <p data-translate-key="signature">Apps by Ato</p>
                <p class="text-xs text-gray-600 mt-4" data-translate-key="disclaimer">Dofus and any related images used on this website are the properties of Ankama</p>
                <p class="text-xs text-gray-600 mt-2" data-translate-key="version_info"></p>
            </footer>
        </div>
    </div>

    <script>
        // Moved setLanguage and calculateDropRate outside DOMContentLoaded for global access
        const translations = {
            fr: {
                btn_back_home: "â† Retour Ã  l'accueil",
                signature: "Apps by Ato",
                disclaimer: "Dofus et toutes les images associÃ©es utilisÃ©es sur ce site sont la propriÃ©tÃ© d'Ankama",
                version_info: "Version 2.0.21 - Juillet 2025", // Updated version
                drop_calculator_main_title: "Calculateur de Taux de Butin",
                drop_calculator_subtitle: "Estimez vos chances d'obtenir des objets !",
                drop_calculator_form_title: "Calculer le Taux de Butin",
                label_item_name: "Nom de l'objet (Ex: Casque CassÃ© du Chafer):",
                label_base_drop_rate: "Taux de butin de base (%) (Ex: 8.4 pour Casque CassÃ© du Chafer):",
                label_player_pp: "Votre Prospection (PP):",
                label_challenge_bonus: "Bonus de dÃ©fi (%) (Ex: 50 pour un dÃ©fi rÃ©ussi):",
                label_anomaly_bonus: "% Anomalie (0-120%):",
                label_ankama_shield: "Activer Ankama Shield (+5% bonus)",
                btn_calculate_drop_rate: "Calculer le Taux de Butin",
                drop_result_prefix: "Pour l'objet",
                drop_estimated_rate: "Taux de butin estimÃ©",
                drop_average_combats: "Vous avez 1 chance sur",
                drop_error_message: "Veuillez entrer des valeurs numÃ©riques valides pour le taux de base, la prospection (min 100), le bonus de dÃ©fi (min 0) et le bonus d'anomalie (entre 0 et 120).",
                drop_error_item_name: "Veuillez entrer un nom pour l'objet.",
                item_not_found: "Objet non trouvÃ©.",
                fetching_data: "Recherche en cours...",
                no_base_drop_rate: "Aucun taux de butin de base trouvÃ© pour cet objet via les monstres. Veuillez l'entrer manuellement.",
                label_select_monster_drop: "SÃ©lectionnez un monstre pour prÃ©-remplir le taux de butin :",
                no_monster_drops: "Aucun monstre ne semble laisser tomber cet objet, ou les donnÃ©es ne sont pas disponibles."
            },
            en: {
                btn_back_home: "â† Back to Home",
                signature: "Apps by Ato",
                disclaimer: "Dofus and any related images used on this website are the properties of Ankama",
                version_info: "Version 2.0.19 - July 2025", // Updated version
                drop_calculator_main_title: "Drop Rate Calculator",
                drop_calculator_subtitle: "Estimate your chances of obtaining items!",
                drop_calculator_form_title: "Calculate Drop Rate",
                label_item_name: "Item Name (Ex: Broken Chafer Helmet):",
                label_base_drop_rate: "Base Drop Rate (%) (Ex: 8.4 for Broken Chafer Helmet):",
                label_player_pp: "Your Prospecting (PP):",
                label_challenge_bonus: "Challenge Bonus (%) (Ex: 50 for a successful challenge):",
                label_anomaly_bonus: "Anomaly % (0-120%):",
                label_ankama_shield: "Activate Ankama Shield (+5% bonus)",
                btn_calculate_drop_rate: "Calculate Drop Rate",
                drop_result_prefix: "For the item",
                drop_estimated_rate: "Estimated drop rate",
                drop_average_combats: "You have 1 chance in",
                drop_error_message: "Please enter valid numeric values for base rate, prospecting (min 100), challenge bonus (min 0), and anomaly bonus (between 0 and 120).",
                drop_error_item_name: "Please enter an item name.",
                item_not_found: "Item not found.",
                fetching_data: "Searching...",
                no_base_drop_rate: "No base drop rate found for this item via monsters. Please enter it manually.",
                label_select_monster_drop: "Select a monster to pre-fill the drop rate:",
                no_monster_drops: "No monsters seem to drop this item, or data is unavailable."
            },
            es: {
                btn_back_home: "â† Volver al Inicio",
                signature: "Apps by Ato",
                disclaimer: "Dofus y cualquier imagen relacionada utilizada en este sitio web son propiedad de Ankama",
                version_info: "VersiÃ³n 2.0.19 - Julio 2025", // Updated version
                drop_calculator_main_title: "Calculadora de Tasa de Drop",
                drop_calculator_subtitle: "Â¡Estima tus posibilidades de conseguir objetos!",
                drop_calculator_form_title: "Calcular Tasa de Drop",
                label_item_name: "Nombre del objeto (Ej: Casco Roto de Chafer):",
                label_base_drop_rate: "Tasa de drop base (%) (Ej: 8.4 para Casco Roto de Chafer):",
                label_player_pp: "Tu ProspecciÃ³n (PP):",
                label_challenge_bonus: "Bono de desafÃ­o (%) (Ej: 50 para un desafÃ­o exitoso):",
                label_anomaly_bonus: "% AnomalÃ­a (0-120%):",
                label_ankama_shield: "Activar Ankama Shield (+5% bonus)",
                btn_calculate_drop_rate: "Calcular Tasa de Drop",
                drop_result_prefix: "Para el objeto",
                drop_estimated_rate: "Tasa de drop estimada",
                drop_average_combats: "Tienes 1 oportunidad entre",
                drop_error_message: "Por favor, introduce valores numÃ©ricos vÃ¡lidos para la tasa base, la prospecciÃ³n (mÃ­n. 100), el bono de desafÃ­o (mÃ­n. 0) y el bono de anomalÃ­a (entre 0 et 120).",
                item_not_found: "Objeto non encontrado.",
                fetching_data: "Buscando...",
                no_base_drop_rate: "No se encontrÃ³ una tasa de drop base para este objeto a travÃ©s de monstruos. Por favor, introdÃºcela manualmente.",
                label_select_monster_drop: "Selecciona un monstro para pre-remplir le taux de butin :",
                no_monster_drops: "NingÃºn monstro parece soltar este objeto, o los datos no estÃ¡n disponibles."
            },
            'pt-br': {
                btn_back_home: "â† Voltar ao Inicio",
                signature: "Apps by Ato",
                disclaimer: "Dofus e quaisquer images relacionadas usadas neste site sÃ£o propriedade da Ankama",
                version_info: "VersÃ£o 2.0.15 - Julho 2025", // Updated version
                drop_calculator_main_title: "Calculadora Taxa de Drop",
                drop_calculator_subtitle: "Estime suas chances de obter itens!",
                drop_calculator_form_title: "Calcular Taxa de Drop",
                label_item_name: "Nome do Item (Ex: Capacete Quebrado de Chafer):",
                label_base_drop_rate: "Taxa de Drop Base (%) (Ex: 8.4 para Capacete Quebrado de Chafer):",
                label_player_pp: "Sua ProspecÃ§Ã£o (PP):",
                label_challenge_bonus: "BÃ´nus de Desafio (%) (Ex: 50 para um desafio bem-sucedido):",
                label_anomaly_bonus: "% Anomalia (0-120%):",
                label_ankama_shield: "Ativar Ankama Shield (+5% bÃ´nus)",
                btn_calculate_drop_rate: "Calcular Taxa de Drop",
                drop_result_prefix: "Para o item",
                drop_estimated_rate: "Taxa de drop estimada",
                drop_average_combats: "VocÃª tem 1 chance em",
                drop_error_message: "Por favor, insira valores numÃ©ricos vÃ¡lidos para a taxa base, prospecÃ§Ã£o (mÃ­n. 100), bÃ´nus de desafio (mÃ­n. 0) e bÃ´nus de anomalia (entre 0 e 120).",
                item_not_found: "Item nÃ£o encontrado.",
                fetching_data: "Pesquisando...",
                no_base_drop_rate: "Nenhuma taxa de drop base encontrada para este item via monstros. Por favor, insira-a manualmente.",
                label_select_monster_drop: "Selecione um monstro para preencher a taxa de drop:",
                no_monster_drops: "Nenhum monstro parece dropar este item, ou os dados nÃ£o estÃ£o disponÃ­veis."
            },
            it: {
                btn_back_home: "â† Torna alla Home",
                signature: "Apps by Ato",
                disclaimer: "Dofus e qualsiasi image correlata utilizzata su questo site Web Ã¨ di proprietÃ  di Ankama",
                version_info: "VersÃ£o 2.0.11 - Luglio 2025", // Updated version
                drop_calculator_main_title: "Calcolatore Tasso di Drop",
                drop_calculator_subtitle: "Stima le tue possibilitÃ  di ottenere oggetti!",
                drop_calculator_form_title: "Calcola Tasso di Drop",
                label_item_name: "Nom de l'oggetto (Es: Elmo Rotto di Chafer):",
                label_base_drop_rate: "Tasso di drop base (%) (Es: 8.4 per Elmo Rotto di Chafer):",
                label_player_pp: "La tua Prospezione (PP):",
                label_challenge_bonus: "Bonus di sfida (%) (Es: 50 per una sfida riuscita):",
                label_anomaly_bonus: "% Anomalia (0-120%):",
                label_ankama_shield: "Attiva Ankama Shield (+5% bonus)",
                btn_calculate_drop_rate: "Calcola Tasso di Drop",
                drop_result_prefix: "Per l'oggetto",
                drop_estimated_rate: "Tasso di drop stimato",
                drop_average_combats: "Hai 1 possibilitÃ  su",
                drop_error_message: "Inserisci valori numerici validi per il tasso base, la prospezione (min 100), il bonus di sfida (min 0) e il bonus di anomalia (tra 0 e 120).",
                item_not_found: "Oggetto non trovato.",
                fetching_data: "Ricerca in corso...",
                no_base_drop_rate: "Nessun tasso di drop base trovato per questo oggetto tramite i mostri. Inseriscilo manualmente.",
                label_select_monster_drop: "Seleziona un monstro per precompilare il tasso di drop:",
                no_monster_drops: "Nessun mostro sembra rilasciare questo oggetto, o i dati non sono disponibili."
            }
        };

        // Function to handle language setting and translation
        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('dofusDropLang', lang);
            document.documentElement.lang = lang;
            languageSelector.value = lang;

            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.getAttribute('data-translate-key');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });

            // For placeholders, use data-translate-key-placeholder
            document.querySelectorAll('[data-translate-key-placeholder]').forEach(element => {
                const key = element.getAttribute('data-translate-key-placeholder');
                if (translations[lang] && translations[lang][key]) {
                    element.placeholder = translations[lang][key];
                }
            });
            hideMessage(dropResultDiv);
            hideMessage(dropErrorDiv);
            hideMessage(dropInfoDiv);
        }

        // Drop Rate Calculator Logic (already global)
        window.calculateDropRate = function() {
            hideMessage(dropResultDiv);
            hideMessage(dropErrorDiv);
            hideMessage(dropInfoDiv);

            const itemName = dropItemNameInput.value.trim();
            const baseDropRate = parseFloat(dropBaseDropRateInput.value);
            let playerPP = parseFloat(dropPlayerPPInput.value);
            const challengeBonus = parseFloat(dropChallengeBonusInput.value);
            let anomalyBonus = parseFloat(dropAnomalyBonusInput.value);
            const isAnkamaShieldActive = ankamaShieldToggle.checked;

            if (isNaN(baseDropRate) || isNaN(playerPP) || isNaN(challengeBonus) || isNaN(anomalyBonus) || baseDropRate <= 0 || playerPP < 100 || anomalyBonus < 0 || anomalyBonus > 120) {
                showMessage(dropErrorDiv, translations[currentLanguage].drop_error_message, 'error');
                return;
            }

            if (itemName === "") {
                showMessage(dropErrorDiv, translations[currentLanguage].drop_error_item_name, 'error');
                return;
            }

            // PP Multiplier formula based on Dofus mechanics (simplified)
            let ppMultiplier;
            if (playerPP < 0) { // Should not happen with min="100" but as a safeguard
                ppMultiplier = 1;
            } else {
                const exponent = (250 - playerPP) / 85;
                ppMultiplier = 0.74 + (1.755 / (1 + Math.exp(exponent)));
                ppMultiplier = Math.min(ppMultiplier, 2.5); // Cap at 2.5 (250% of base)
            }

            let effectiveDropRate = baseDropRate * ppMultiplier * (1 + challengeBonus / 100);

            if (anomalyBonus > 0) {
                effectiveDropRate *= (1 + anomalyBonus / 100);
            }

            if (isAnkamaShieldActive) {
                effectiveDropRate *= (1 + 5 / 100); // +5% bonus from Ankama Shield
            }

            let chanceDenominator = 0;
            if (effectiveDropRate > 0) {
                chanceDenominator = 100 / effectiveDropRate;
            } else {
                chanceDenominator = Infinity; // Avoid division by zero
            }

            dropResultDiv.innerHTML = `
                <p class="font-bold">${translations[currentLanguage].drop_result_prefix} "<strong>${itemName}</strong>" :</p>
                <ul class="list-none mt-2">
                    <li class="text-lg mt-2"><strong>${translations[currentLanguage].drop_estimated_rate} : <span class="text-teal-300">${effectiveDropRate.toFixed(2)}%</span></strong></li>
                    <li class="text-gray-400 italic mt-4"><em>${translations[currentLanguage].drop_average_combats} <span class="font-semibold">${chanceDenominator.toFixed(0)}</span> !</em></li>
                </ul>
            `;
            dropResultDiv.classList.remove('hidden');
        };


        document.addEventListener('DOMContentLoaded', () => {
            // Elements for Drop Calculator
            const dropItemNameInput = document.getElementById('dropItemName');
            const dropBaseDropRateInput = document.getElementById('dropBaseDropRate');
            const dropPlayerPPInput = document.getElementById('dropPlayerPP');
            const dropChallengeBonusInput = document.getElementById('dropChallengeBonus');
            const dropAnomalyBonusInput = document.getElementById('dropAnomalyBonus');
            const ankamaShieldToggle = document.getElementById('ankamaShieldToggle');
            const dropResultDiv = document.getElementById('drop-result');
            const dropErrorDiv = document.getElementById('drop-error-message');
            const dropInfoDiv = document.getElementById('drop-info-message'); // New info message div
            const languageSelector = document.getElementById('language-selector');
            const itemIcon = document.getElementById('itemIcon');
            const autocompleteSuggestions = document.getElementById('autocompleteSuggestions');
            const monsterDropSuggestions = document.getElementById('monsterDropSuggestions'); // New monster drop section
            const monsterDropList = document.getElementById('monsterDropList'); // List within monster drop section
            const versionInfoElement = document.querySelector('[data-translate-key="version_info"]'); // Get the version info element

            let currentLanguage = 'fr'; // Initialize currentLanguage here

            const DOFUSDB_API_BASE_URL = 'https://api.dofusdb.fr';

            // Function to normalize string for slug search
            function normalizeString(str) {
                // Convert to NFD form and remove diacritics (accents)
                str = str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                // Convert to lowercase
                str = str.toLowerCase();
                // Replace any non-alphanumeric characters (except spaces) with nothing
                str = str.replace(/[^a-z0-9\s]/g, "");
                return str; // Return with spaces, encodeURIComponent will handle them
            }

            // Utility function to display messages
            function showMessage(element, message, type) {
                element.innerHTML = `<p>${message}</p>`;
                element.className = `message-box ${type}`;
                element.classList.remove('hidden');
            }

            function hideMessage(element) {
                element.classList.add('hidden');
                element.innerHTML = '';
            }

            // Function to control visibility of the monster suggestions box
            function setMonsterSuggestionsVisibility(isVisible) {
                if (isVisible) {
                    monsterDropSuggestions.classList.add('is-visible');
                    monsterDropSuggestions.classList.remove('hidden'); // Ensure Tailwind's hidden is removed
                } else {
                    monsterDropSuggestions.classList.remove('is-visible');
                    monsterDropSuggestions.classList.add('hidden'); // Add Tailwind's hidden for consistency
                }
            }

            // Function to display monster drop options based on the selected item's drop data
            async function displayMonsterDropOptions(item) {
                monsterDropList.innerHTML = ''; // Clear previous list items
                hideMessage(dropInfoDiv); // Hide info message
                hideMessage(dropErrorDiv); // Hide error message
                setMonsterSuggestionsVisibility(false); // Hide the container initially

                let dropGroupsToProcess = [];

                if (item.dropGroups && item.dropGroups.length > 0) {
                    console.log("Using dropGroups from item for monster details and rates.");
                    // Extract monsterIds from dropGroups
                    const monsterIdsFromGroups = item.dropGroups.map(group => group.monsterId).filter(id => id !== undefined);
                    // For dropGroups, we need to fetch random-drop-groups for each monster to get the rate
                    dropGroupsToProcess = await Promise.all(monsterIdsFromGroups.map(async monsterId => {
                        try {
                            const response = await fetch(`${DOFUSDB_API_BASE_URL}/random-drop-groups?itemId=${item.id}&monsterId=${monsterId}`);
                            if (!response.ok) {
                                console.error(`API request for random-drop-groups for item ${item.id}, monster ${monsterId} failed with status ${response.status}.`);
                                return { monsterId: monsterId, rate: "N/A" }; // Fallback
                            }
                            const dropData = await response.json();
                            // Access 'rate' directly from the array, not from a 'data' property
                            const rate = (dropData && dropData.length > 0 && dropData[0].rate !== undefined) ? dropData[0].rate : "N/A";
                            return { monsterId: monsterId, rate: rate };
                        } catch (error) {
                            console.error(`Error fetching random-drop-groups for item ${item.id}, monster ${monsterId}:`, error);
                            return { monsterId: monsterId, rate: "N/A" }; // Fallback on error
                        }
                    }));
                } else if (item.dropMonsterIds && item.dropMonsterIds.length > 0) {
                    console.log("Using dropMonsterIds directly for monster details and rates.");
                    // For dropMonsterIds, we need to fetch each monster and then find the item's drop rate within its drops array
                    dropGroupsToProcess = await Promise.all(item.dropMonsterIds.map(async monsterId => {
                        try {
                            const response = await fetch(`${DOFUSDB_API_BASE_URL}/monsters/${monsterId}`);
                            if (!response.ok) {
                                console.error(`API request for monster ${monsterId} failed with status ${response.status}. URL: ${response.url}`);
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            const monster = await response.json();
                            
                            let rate = "N/A";
                            if (monster.drops && monster.drops.length > 0) {
                                const itemDrop = monster.drops.find(d => d.objectId === item.id);
                                if (itemDrop) {
                                    // Prioritize higher grades, then fall back
                                    if (itemDrop.percentDropForGrade5 !== undefined && itemDrop.percentDropForGrade5 > 0) {
                                        rate = itemDrop.percentDropForGrade5;
                                    } else if (itemDrop.percentDropForGrade4 !== undefined && itemDrop.percentDropForGrade4 > 0) {
                                        rate = itemDrop.percentDropForGrade4;
                                    } else if (itemDrop.percentDropForGrade3 !== undefined && itemDrop.percentDropForGrade3 > 0) {
                                        rate = itemDrop.percentDropForGrade3;
                                    } else if (itemDrop.percentDropForGrade2 !== undefined && itemDrop.percentDropForGrade2 > 0) {
                                        rate = itemDrop.percentDropForGrade2;
                                    } else if (itemDrop.percentDropForGrade1 !== undefined && itemDrop.percentDropForGrade1 > 0) {
                                        rate = itemDrop.percentDropForGrade1;
                                    } else if (itemDrop.rate !== undefined) { // Fallback to a general 'rate' if present
                                        rate = itemDrop.rate;
                                    }
                                }
                            }
                            return { monsterId: monsterId, monster: monster, rate: rate }; // Return monster object directly
                        } catch (error) {
                            console.error(`Error fetching monster ${monsterId}:`, error);
                            return null; // Return null for failed fetches
                        }
                    }));
                } else {
                    // This block is executed if neither dropGroups nor dropMonsterIds are present in the item data
                    showMessage(dropInfoDiv, translations[currentLanguage].no_monster_drops, 'info');
                    setMonsterSuggestionsVisibility(false); // Ensure the suggestions box is hidden
                    return;
                }

                // Filter out nulls from dropGroupsToProcess and then fetch monster details for those that only have monsterId
                const finalMonsterDrops = [];
                for (const group of dropGroupsToProcess) {
                    if (group && group.monsterId) {
                        let monsterDetails = group.monster; // Already fetched if from dropMonsterIds path
                        if (!monsterDetails) { // If it came from dropGroups path, we need to fetch monster details
                            try {
                                const response = await fetch(`${DOFUSDB_API_BASE_URL}/monsters/${group.monsterId}`);
                                if (!response.ok) {
                                    console.error(`API request for monster ${group.monsterId} failed with status ${response.status}. URL: ${response.url}`);
                                    continue; // Skip this monster if fetch fails
                                }
                                monsterDetails = await response.json();
                            } catch (error) {
                                console.error(`Error fetching monster ${group.monsterId}:`, error);
                                continue; // Skip this monster on error
                            }
                        }
                        if (monsterDetails) {
                             // Ensure rate is correctly passed from the initial random-drop-groups fetch if applicable
                            const actualRate = group.rate !== undefined ? group.rate : (monsterDetails.drops && monsterDetails.drops.find(d => d.objectId === item.id)?.percentDropForGrade5 || "N/A");
                            finalMonsterDrops.push({ monster: monsterDetails, rate: actualRate });
                        }
                    }
                }
                
                console.log("Final Monster Drops (after all processing):", finalMonsterDrops);

                if (finalMonsterDrops.length > 0) {
                    finalMonsterDrops.forEach(({ monster, rate }) => {
                        const monsterDropDiv = document.createElement('div');
                        monsterDropDiv.classList.add('monster-drop-item');
                        // Apply toFixed(2) if rate is a number
                        const formattedRate = typeof rate === 'number' ? rate.toFixed(2) : rate;
                        const innerHtmlContent = `
                            <img src="${monster.img || 'https://placehold.co/28x28/1f2937/9ca3af?text=?'}" onerror="this.onerror=null;this.src='https://placehold.co/28x28/1f2937/9ca3af?text=?';" alt="IcÃ´ne de ${monster.name.fr || monster.name.en || 'Monstre'}">
                            <span>${monster.name.fr || monster.name.en || 'Nom inconnu'}</span>
                            <span class="drop-rate">${formattedRate}%</span>
                        `;
                        monsterDropDiv.innerHTML = innerHtmlContent;
                        console.log("Generated monsterDropDiv HTML:", innerHtmlContent);
                        
                        // Add click listener for selection to pre-fill the base drop rate
                        monsterDropDiv.addEventListener('click', () => {
                            // Remove 'is-selected' from all other items first
                            const currentSelected = monsterDropList.querySelector('.monster-drop-item.is-selected');
                            if (currentSelected) {
                                currentSelected.classList.remove('is-selected');
                            }
                            // Add 'is-selected' to the clicked item
                            monsterDropDiv.classList.add('is-selected');

                            if (typeof rate === 'number') {
                                dropBaseDropRateInput.value = rate.toFixed(2); // Pre-fill with rounded rate
                                showMessage(dropInfoDiv, `Taux de butin prÃ©-rempli avec ${formattedRate}% pour ${monster.name.fr}.`, 'info');
                                // Keep the list visible after selection
                            } else {
                                showMessage(dropInfoDiv, `Taux de butin non spÃ©cifiÃ© pour ${monster.name.fr}.`, 'info');
                            }
                        });

                        monsterDropList.appendChild(monsterDropDiv);
                    });
                    setMonsterSuggestionsVisibility(true); // Make the container visible
                    console.log("monsterDropList children count:", monsterDropList.children.length); // Log children count
                } else {
                    showMessage(dropInfoDiv, translations[currentLanguage].no_monster_drops, 'info');
                    setMonsterSuggestionsVisibility(false); // Ensure the container is hidden
                }
            }


            // Function to fetch Dofus items from API for autocomplete
            async function fetchItemsForAutocomplete(searchTerm) {
                hideMessage(dropErrorDiv);
                hideMessage(dropResultDiv);
                setMonsterSuggestionsVisibility(false); // Hide monster suggestions when typing
                dropBaseDropRateInput.removeAttribute('disabled'); // Enable manual input

                let normalizedSearchTerm = normalizeString(searchTerm);
                normalizedSearchTerm = encodeURIComponent(normalizedSearchTerm).replace(/%20/g, '+');

                if (normalizedSearchTerm.length < 4) {
                    autocompleteSuggestions.classList.add('hidden');
                    autocompleteSuggestions.innerHTML = '';
                    if (searchTerm.length > 0) {
                        showMessage(dropInfoDiv, `Veuillez taper au moins 4 caractÃ¨res pour la recherche.`, 'info');
                    } else {
                        hideMessage(dropInfoDiv);
                    }
                    return;
                }

                showMessage(dropInfoDiv, translations[currentLanguage].fetching_data, 'info');
                autocompleteSuggestions.innerHTML = ''; // Clear previous suggestions
                autocompleteSuggestions.classList.remove('hidden');

                try {
                    const baseUrl = 'https://api.dofusdb.fr/items';
                    const paramsArray = [
                        `typeId[$ne]=203`,
                        `$sort=-id`,
                        `slug.fr[$search]=${normalizedSearchTerm}`,
                        `level[$gte]=0`,
                        `level[$lte]=200`,
                        `$skip=0`,
                        `lang=fr`
                    ];
                    const queryString = paramsArray.join('&');
                    const fullUrl = `${baseUrl}?${queryString}`;
                    
                    console.log("RequÃªte API envoyÃ©e:", fullUrl);

                    const response = await fetch(fullUrl);
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status} - ${JSON.stringify(data)}`);
                    }

                    hideMessage(dropInfoDiv);

                    if (data.data && data.data.length > 0) {
                        data.data.forEach(item => {
                            const suggestionDiv = document.createElement('div');
                            suggestionDiv.classList.add('autocomplete-suggestion-item');
                            suggestionDiv.innerHTML = `
                                <img src="${item.img || 'https://placehold.co/32x32/1f2937/9ca3af?text=?'}" onerror="this.onerror=null;this.src='https://placehold.co/32x32/1f2937/9ca3af?text=?';" alt="IcÃ´ne de ${item.name.fr || item.name.en || 'Objet'}">
                                <span>${item.name.fr || item.name.en || 'Nom inconnu'}</span>
                            `;
                            suggestionDiv.addEventListener('click', (event) => {
                                event.preventDefault();
                                selectItem(item);
                                autocompleteSuggestions.classList.add('hidden');
                            });
                            autocompleteSuggestions.appendChild(suggestionDiv);
                        });
                    } else {
                        autocompleteSuggestions.classList.add('hidden');
                        showMessage(dropErrorDiv, translations[currentLanguage].item_not_found, 'error');
                    }
                } catch (error) {
                    console.error("Erreur lors de la rÃ©cupÃ©ration des objets:", error);
                    hideMessage(dropInfoDiv);
                    showMessage(dropErrorDiv, translations[currentLanguage].item_not_found + " " + (error.message || ""), 'error');
                    autocompleteSuggestions.classList.add('hidden');
                }
            }

            // Function to handle item selection from autocomplete
            async function selectItem(item) {
                selectedItem = item;
                console.log("Selected Item:", selectedItem);
                dropItemNameInput.value = item.name.fr || item.name.en || '';
                itemIcon.src = item.img || "https://placehold.co/32x32/1f2937/9ca3af?text=?";
                itemIcon.onerror = function() { this.onerror=null; this.src='https://placehold.co/32x32/1f2937/9ca3af?text=?'; };
                hideMessage(dropErrorDiv);
                hideMessage(dropResultDiv);
                hideMessage(dropInfoDiv);
                dropBaseDropRateInput.value = ''; // Clear previous value
                dropBaseDropRateInput.removeAttribute('disabled'); // Ensure it's enabled for manual input initially

                // Call the displayMonsterDropOptions directly with the selected item
                await displayMonsterDropOptions(selectedItem);
            }
            
            // Drop Rate Calculator Logic
            window.calculateDropRate = function() {
                hideMessage(dropResultDiv);
                hideMessage(dropErrorDiv);
                hideMessage(dropInfoDiv);

                const itemName = dropItemNameInput.value.trim();
                const baseDropRate = parseFloat(dropBaseDropRateInput.value);
                let playerPP = parseFloat(dropPlayerPPInput.value);
                const challengeBonus = parseFloat(dropChallengeBonusInput.value);
                let anomalyBonus = parseFloat(dropAnomalyBonusInput.value);
                const isAnkamaShieldActive = ankamaShieldToggle.checked;

                if (isNaN(baseDropRate) || isNaN(playerPP) || isNaN(challengeBonus) || isNaN(anomalyBonus) || baseDropRate <= 0 || playerPP < 100 || anomalyBonus < 0 || anomalyBonus > 120) {
                    showMessage(dropErrorDiv, translations[currentLanguage].drop_error_message, 'error');
                    return;
                }

                if (itemName === "") {
                    showMessage(dropErrorDiv, translations[currentLanguage].drop_error_item_name, 'error');
                    return;
                }

                // PP Multiplier formula based on Dofus mechanics (simplified)
                let ppMultiplier;
                if (playerPP < 0) { // Should not happen with min="100" but as a safeguard
                    ppMultiplier = 1;
                } else {
                    const exponent = (250 - playerPP) / 85;
                    ppMultiplier = 0.74 + (1.755 / (1 + Math.exp(exponent)));
                    ppMultiplier = Math.min(ppMultiplier, 2.5); // Cap at 2.5 (250% of base)
                }

                let effectiveDropRate = baseDropRate * ppMultiplier * (1 + challengeBonus / 100);

                if (anomalyBonus > 0) {
                    effectiveDropRate *= (1 + anomalyBonus / 100);
                }

                if (isAnkamaShieldActive) {
                    effectiveDropRate *= (1 + 5 / 100); // +5% bonus from Ankama Shield
                }

                let chanceDenominator = 0;
                if (effectiveDropRate > 0) {
                    chanceDenominator = 100 / effectiveDropRate;
                } else {
                    chanceDenominator = Infinity; // Avoid division by zero
                }

                dropResultDiv.innerHTML = `
                    <p class="font-bold">${translations[currentLanguage].drop_result_prefix} "<strong>${itemName}</strong>" :</p>
                    <ul class="list-none mt-2">
                        <li class="text-lg mt-2"><strong>${translations[currentLanguage].drop_estimated_rate} : <span class="text-teal-300">${effectiveDropRate.toFixed(2)}%</span></strong></li>
                        <li class="text-gray-400 italic mt-4"><em>${translations[currentLanguage].drop_average_combats} <span class="font-semibold">${chanceDenominator.toFixed(0)}</span> !</em></li>
                    </ul>
                `;
                dropResultDiv.classList.remove('hidden');
            };

            // Event Listeners
            languageSelector.addEventListener('change', (e) => setLanguage(e.target.value));
            
            // Debounce function for autocomplete to limit API calls
            let debounceTimer;
            dropItemNameInput.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    fetchItemsForAutocomplete(dropItemNameInput.value);
                }, 300); // 300ms delay
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!dropItemNameInput.contains(e.target) && !autocompleteSuggestions.contains(e.target)) {
                    autocompleteSuggestions.classList.add('hidden');
                }
                // Keep monster suggestions visible until an option is chosen or item name is cleared
            });

            // Initial Load
            const savedLang = localStorage.getItem('dofusDropLang') || 'fr';
            setLanguage(savedLang);

            // Set the version information in the footer
            if (versionInfoElement) {
                versionInfoElement.textContent = translations[currentLanguage].version_info;
            }

            // Perform initial search for the default item on page load
            // This will now trigger the new monster fetching logic
            dropItemNameInput.value = ''; // Clear on initial load
            // No initial fetch, wait for user input
        });
    </script>

</body>
</html>
