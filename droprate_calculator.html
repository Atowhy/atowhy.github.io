<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dofus Droprate Calculator</title>
    <link rel="stylesheet" href="style.css"> <!-- Assuming you have a style.css -->
</head>
<body>
    <h1>Dofus Droprate Calculator</h1>

    <!-- Input for item search -->
    <label for="itemSearchInput">Search Item:</label>
    <input type="text" id="itemSearchInput" value="Iron">
    <button id="searchButton">Search</button>

    <div id="itemInfo">
        <h2>Item Details:</h2>
        <p>Item Name: <span id="itemName">N/A</span></p>
        <p>Item ID: <span id="itemId">N/A</span></p>
        <h3>Monsters that drop this item:</h3>
        <ul id="monsterList">
            <li>No data yet.</li>
        </ul>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const itemSearchInput = document.getElementById('itemSearchInput');
            const searchButton = document.getElementById('searchButton');
            const itemNameSpan = document.getElementById('itemName');
            const itemIdSpan = document.getElementById('itemId');
            const monsterList = document.getElementById('monsterList');

            // Dofusdude API base URL (the one with clear documentation for search)
            const dofusDudeApiBase = 'https://api.dofusdu.de';
            
            // The CORS proxy URL - STILL ESSENTIAL FOR GITHUB PAGES
            const corsProxy = 'https://corsproxy.io/'; 

            searchButton.addEventListener('click', fetchItemData);

            // Allow pressing Enter in the input field to trigger search
            itemSearchInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    fetchItemData();
                }
            });

            // Initial fetch on load for "Iron"
            fetchItemData();

            async function fetchItemData() {
                const searchTerm = itemSearchInput.value.trim();
                if (!searchTerm) {
                    alert('Please enter an item name to search.');
                    return;
                }

                itemNameSpan.textContent = 'Loading...';
                itemIdSpan.textContent = 'Loading...';
                monsterList.innerHTML = '<li>Loading...</li>';

                try {
                    // 1. Search for the item using dofusdude's documented search endpoint
                    const itemApiEndpoint = `/dofus3/v1/en/items/resources/search?query=${encodeURIComponent(searchTerm)}`;
                    const itemApiUrl = `${corsProxy}?${encodeURIComponent(dofusDudeApiBase + itemApiEndpoint)}`;
                    
                    console.log('Fetching item from (via proxy):', itemApiUrl);

                    const itemResponse = await fetch(itemApiUrl);
                    if (!itemResponse.ok) {
                        // Log the full response text for more details on HTTP errors
                        const errorText = await itemResponse.text();
                        throw new Error(`HTTP error! Status: ${itemResponse.status}. Details: ${errorText}`);
                    }
                    const itemData = await itemResponse.json();
                    console.log('Item API Response (dofusdude):', itemData);

                    let foundItem = null;
                    if (itemData && itemData.length > 0) {
                        // Assuming the first result is the most relevant
                        foundItem = itemData[0]; 
                        itemNameSpan.textContent = foundItem.name.en || foundItem.name || 'Name not available'; 
                        itemIdSpan.textContent = foundItem.ankamaId || 'ID not available'; // dofusdude uses ankamaId
                    } else {
                        itemNameSpan.textContent = 'Item not found.';
                        itemIdSpan.textContent = 'N/A';
                        monsterList.innerHTML = '<li>Item not found.</li>';
                        return; 
                    }

                    // 2. Attempt to find monsters that drop this item.
                    // The dofusdude API's monster endpoint: /{game}/v1/{language}/monsters
                    // We need to check if monster objects contain 'drops' information that links to item IDs.
                    // Let's fetch a few monsters and inspect their structure.

                    const monsterApiEndpoint = `/dofus3/v1/en/monsters?$limit=20`; // Fetch first 20 monsters
                    const monsterApiUrl = `${corsProxy}?${encodeURIComponent(dofusDudeApiBase + monsterApiEndpoint)}`;
                    console.log('Fetching monsters from (via proxy):', monsterApiUrl);

                    const monsterResponse = await fetch(monsterApiUrl);
                    if (!monsterResponse.ok) {
                        const errorText = await monsterResponse.text();
                        throw new Error(`HTTP error! Status: ${monsterResponse.status}. Details: ${errorText}`);
                    }
                    const monsterData = await monsterResponse.json();
                    console.log('Monster API Response (dofusdude):', monsterData);

                    if (monsterData && monsterData.length > 0) {
                        monsterList.innerHTML = ''; // Clear previous loading message
                        let foundDrops = false;
                        monsterData.forEach(monster => {
                            // This part is still hypothetical based on common API patterns.
                            // We need to examine the 'Monster API Response' in your console to confirm the exact structure.
                            if (monster.drops && Array.isArray(monster.drops)) {
                                monster.drops.forEach(drop => {
                                    // Assuming 'drop.item' or 'drop.itemId' exists and matches foundItem.ankamaId
                                    if (drop.item && drop.item.ankamaId === foundItem.ankamaId) {
                                        const listItem = document.createElement('li');
                                        // Drop rates are often percentages or base values. Need to confirm structure.
                                        listItem.textContent = `${monster.name.en || monster.name} (Drop Rate: ${drop.rate || 'N/A'}%)`;
                                        monsterList.appendChild(listItem);
                                        foundDrops = true;
                                    }
                                });
                            }
                        });

                        if (!foundDrops) {
                            monsterList.innerHTML = '<li>No monsters found that directly drop this item in the fetched sample (or API structure needs more investigation).</li>';
                        }
                    } else {
                        monsterList.innerHTML = '<li>No monster data available from API.</li>';
                    }

                } catch (error) {
                    console.error('Fetch error:', error);
                    itemNameSpan.textContent = 'Error loading item.';
                    itemIdSpan.textContent = 'Error.';
                    monsterList.innerHTML = `<li>Error: ${error.message}</li>`;
                }
            }
        });
    </script>
</body>
</html>